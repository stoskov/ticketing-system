@using TicketingSystem.Web.Models.Tickets;

@model IEnumerable<TicketSummaryViewModel>

@{
    this.ViewBag.Title = "All Tickets";
}

<h2>All Tickets</h2>

<table class="gridview">
    <tr>
        <th>
            @this.Html.DisplayNameFor(model => model.Title)
        </th>
        <th>
            @this.Html.DisplayNameFor(model => model.CategoryName)
            <div class="ticket-filter">
                @Html.DropDownList("categoryFilter",
                    new SelectList((IEnumerable<SelectListItem>)ViewBag.Categories,
                        "Value", "Text", this.ViewBag.Filter.CategoryId))
            </div>
        </th>
        <th>
            @this.Html.DisplayNameFor(model => model.AuthorName)
        </th>
        <th>
            @this.Html.DisplayNameFor(model => model.Priority)
        </th>
        <th>
            @this.Html.DisplayNameFor(model => model.Status)
        </th>
    </tr>

    @foreach (var item in this.Model)
    {
            <tr>
                <td>
                    <a href='@Url.Action("Details", new { id = item.Id })'>
                        @item.Title
                    </a>
                </td>
                <td>
                    @this.Html.DisplayFor(modelItem => item.CategoryName)
                </td>
                <td>
                    @this.Html.DisplayFor(modelItem => item.AuthorName)
                </td>
                <td>
                    @this.Html.DisplayFor(modelItem => item.Priority)
                </td>
                <td>
                    @this.Html.DisplayFor(modelItem => item.Status)
                </td>
            </tr>
    }
</table>

<div class="pagination">
    <ul>
        @for (int i = 1; i <= this.ViewBag.Pages; i++)
        {
                    <li> @this.Html.ActionLink(i.ToString(), "ListAll", new { id = i, category = 1 }) </li>
        }
    </ul>
</div>

@section scripts{
    <script type="text/javascript">
        $(function () {
            $("#categoryFilter").on("change", function (e) {
                var category = e.target.value,
                categoryIdRegex = /categoryId=[0-9]*/,
                queryString = window.location.search;

                if (categoryIdRegex.test(queryString)) {
                    queryString = queryString.replace(categoryIdRegex, "categoryId=" + category);
                }
                else if (queryString.length > 1) {
                    queryString = queryString + "&categoryId=" + category;
                }
                else {
                    queryString = queryString + "?categoryId=" + category;
                }
        
                window.location.search = queryString;
            });
        });
    </script>
}